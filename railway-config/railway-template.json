{
  "$schema": "https://railway.app/railway.schema.json",
  "name": "PostgreSQL HA Cluster (repmgr)",
  "description": "High Availability PostgreSQL cluster with automatic failover using repmgr. 4 data nodes + 1 witness node.",
  "icon": "https://railway.app/brand/logotype-dark.svg",
  "variables": {
    "POSTGRES_PASSWORD": {
      "description": "PostgreSQL superuser password",
      "type": "string",
      "required": true,
      "isSecret": true
    },
    "REPMGR_PASSWORD": {
      "description": "Repmgr user password for replication and monitoring",
      "type": "string",
      "required": true,
      "isSecret": true
    },
    "APP_READONLY_PASSWORD": {
      "description": "Read-only application user password",
      "type": "string",
      "required": true,
      "isSecret": true
    },
    "APP_READWRITE_PASSWORD": {
      "description": "Read-write application user password",
      "type": "string",
      "required": true,
      "isSecret": true
    },
    "REPMGR_PROMOTE_MAX_LAG_SECS": {
      "description": "Maximum replication lag (seconds) to allow promotion",
      "type": "string",
      "default": "10"
    },
    "RETRY_INTERVAL": {
      "description": "Seconds between connection retries",
      "type": "string",
      "default": "5"
    },
    "RETRY_ROUNDS": {
      "description": "Total retry rounds before giving up",
      "type": "string",
      "default": "36"
    }
  },
  "services": [
    {
      "name": "pg-1",
      "source": {
        "repo": "hiendt2907/pg-ha-repo",
        "ref": "main"
      },
      "builder": "dockerfile",
      "variables": {
        "NODE_NAME": "pg-1",
        "NODE_ID": "1",
        "PRIMARY_HINT": "pg-1.railway.internal",
        "IS_WITNESS": "false",
        "PEERS": "pg-1.railway.internal:5432,pg-2.railway.internal:5432,pg-3.railway.internal:5432,pg-4.railway.internal:5432,witness.railway.internal:5432",
        "POSTGRES_PASSWORD": "${{POSTGRES_PASSWORD}}",
        "REPMGR_PASSWORD": "${{REPMGR_PASSWORD}}",
        "APP_READONLY_PASSWORD": "${{APP_READONLY_PASSWORD}}",
        "APP_READWRITE_PASSWORD": "${{APP_READWRITE_PASSWORD}}",
        "REPMGR_PROMOTE_MAX_LAG_SECS": "${{REPMGR_PROMOTE_MAX_LAG_SECS}}",
        "RETRY_INTERVAL": "${{RETRY_INTERVAL}}",
        "RETRY_ROUNDS": "${{RETRY_ROUNDS}}"
      },
      "volumes": [
        {
          "mountPath": "/var/lib/postgresql/data"
        }
      ]
    },
    {
      "name": "pg-2",
      "source": {
        "repo": "hiendt2907/pg-ha-repo",
        "ref": "main"
      },
      "builder": "dockerfile",
      "variables": {
        "NODE_NAME": "pg-2",
        "NODE_ID": "2",
        "PRIMARY_HINT": "pg-1.railway.internal",
        "IS_WITNESS": "false",
        "PEERS": "pg-1.railway.internal:5432,pg-2.railway.internal:5432,pg-3.railway.internal:5432,pg-4.railway.internal:5432,witness.railway.internal:5432",
        "POSTGRES_PASSWORD": "${{POSTGRES_PASSWORD}}",
        "REPMGR_PASSWORD": "${{REPMGR_PASSWORD}}",
        "APP_READONLY_PASSWORD": "${{APP_READONLY_PASSWORD}}",
        "APP_READWRITE_PASSWORD": "${{APP_READWRITE_PASSWORD}}",
        "REPMGR_PROMOTE_MAX_LAG_SECS": "${{REPMGR_PROMOTE_MAX_LAG_SECS}}",
        "RETRY_INTERVAL": "${{RETRY_INTERVAL}}",
        "RETRY_ROUNDS": "${{RETRY_ROUNDS}}"
      },
      "volumes": [
        {
          "mountPath": "/var/lib/postgresql/data"
        }
      ]
    },
    {
      "name": "pg-3",
      "source": {
        "repo": "hiendt2907/pg-ha-repo",
        "ref": "main"
      },
      "builder": "dockerfile",
      "variables": {
        "NODE_NAME": "pg-3",
        "NODE_ID": "3",
        "PRIMARY_HINT": "pg-1.railway.internal",
        "IS_WITNESS": "false",
        "PEERS": "pg-1.railway.internal:5432,pg-2.railway.internal:5432,pg-3.railway.internal:5432,pg-4.railway.internal:5432,witness.railway.internal:5432",
        "POSTGRES_PASSWORD": "${{POSTGRES_PASSWORD}}",
        "REPMGR_PASSWORD": "${{REPMGR_PASSWORD}}",
        "APP_READONLY_PASSWORD": "${{APP_READONLY_PASSWORD}}",
        "APP_READWRITE_PASSWORD": "${{APP_READWRITE_PASSWORD}}",
        "REPMGR_PROMOTE_MAX_LAG_SECS": "${{REPMGR_PROMOTE_MAX_LAG_SECS}}",
        "RETRY_INTERVAL": "${{RETRY_INTERVAL}}",
        "RETRY_ROUNDS": "${{RETRY_ROUNDS}}"
      },
      "volumes": [
        {
          "mountPath": "/var/lib/postgresql/data"
        }
      ]
    },
    {
      "name": "pg-4",
      "source": {
        "repo": "hiendt2907/pg-ha-repo",
        "ref": "main"
      },
      "builder": "dockerfile",
      "variables": {
        "NODE_NAME": "pg-4",
        "NODE_ID": "4",
        "PRIMARY_HINT": "pg-1.railway.internal",
        "IS_WITNESS": "false",
        "PEERS": "pg-1.railway.internal:5432,pg-2.railway.internal:5432,pg-3.railway.internal:5432,pg-4.railway.internal:5432,witness.railway.internal:5432",
        "POSTGRES_PASSWORD": "${{POSTGRES_PASSWORD}}",
        "REPMGR_PASSWORD": "${{REPMGR_PASSWORD}}",
        "APP_READONLY_PASSWORD": "${{APP_READONLY_PASSWORD}}",
        "APP_READWRITE_PASSWORD": "${{APP_READWRITE_PASSWORD}}",
        "REPMGR_PROMOTE_MAX_LAG_SECS": "${{REPMGR_PROMOTE_MAX_LAG_SECS}}",
        "RETRY_INTERVAL": "${{RETRY_INTERVAL}}",
        "RETRY_ROUNDS": "${{RETRY_ROUNDS}}"
      },
      "volumes": [
        {
          "mountPath": "/var/lib/postgresql/data"
        }
      ]
    },
    {
      "name": "witness",
      "source": {
        "repo": "hiendt2907/pg-ha-repo",
        "ref": "main"
      },
      "builder": "dockerfile",
      "variables": {
        "NODE_NAME": "witness",
        "NODE_ID": "99",
        "PRIMARY_HINT": "pg-1.railway.internal",
        "IS_WITNESS": "true",
        "PEERS": "pg-1.railway.internal:5432,pg-2.railway.internal:5432,pg-3.railway.internal:5432,pg-4.railway.internal:5432,witness.railway.internal:5432",
        "POSTGRES_PASSWORD": "${{POSTGRES_PASSWORD}}",
        "REPMGR_PASSWORD": "${{REPMGR_PASSWORD}}",
        "APP_READONLY_PASSWORD": "${{APP_READONLY_PASSWORD}}",
        "APP_READWRITE_PASSWORD": "${{APP_READWRITE_PASSWORD}}",
        "REPMGR_PROMOTE_MAX_LAG_SECS": "${{REPMGR_PROMOTE_MAX_LAG_SECS}}",
        "RETRY_INTERVAL": "${{RETRY_INTERVAL}}",
        "RETRY_ROUNDS": "${{RETRY_ROUNDS}}"
      },
      "volumes": [
        {
          "mountPath": "/var/lib/postgresql/data"
        }
      ]
    }
  ]
}
