#------------------------------------------------------------------------------
# CONNECTIONS
#------------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
pcp_listen_addresses = '*'
pcp_port = 9898
socket_dir = '/var/run/pgpool'

#------------------------------------------------------------------------------
# BACKEND CONFIGURATION
#------------------------------------------------------------------------------
# Backend 0 - Primary (writes only)
backend_hostname0 = 'pg-1'
backend_port0 = 5432
backend_weight0 = 0              # Weight 0 = NO READ queries
backend_data_directory0 = '/var/lib/postgresql/data'
backend_flag0 = 'ALLOW_TO_FAILOVER'
backend_application_name0 = 'pg-1'

# Backend 1 - Standby (reads)
backend_hostname1 = 'pg-2'
backend_port1 = 5432
backend_weight1 = 1              # Equal weight for load balancing
backend_data_directory1 = '/var/lib/postgresql/data'
backend_flag1 = 'ALLOW_TO_FAILOVER'
backend_application_name1 = 'pg-2'

# Backend 2 - Standby (reads)
backend_hostname2 = 'pg-3'
backend_port2 = 5432
backend_weight2 = 1
backend_data_directory2 = '/var/lib/postgresql/data'
backend_flag2 = 'ALLOW_TO_FAILOVER'
backend_application_name2 = 'pg-3'

#------------------------------------------------------------------------------
# RUNNING MODE
# Tuned for 32 vCPU / 32 GB RAM on Railway
#------------------------------------------------------------------------------
backend_clustering_mode = 'streaming_replication'

# Connection pool sizing (optimized for high concurrency)
num_init_children = 500            # Max concurrent client connections (up from 100)
max_pool = 10                      # Connections per backend per child (down from 20 for better distribution)
                                   # Total backend connections: 500 * 10 = 5000 per backend
                                   
listen_backlog_multiplier = 8     # Queue size = num_init_children * 8 = 4000
serialize_accept = off             # Allow concurrent accepts (multi-core)

# Child process lifecycle
child_life_time = 300              # Recycle children after 5 min (prevent memory leaks)
child_max_connections = 0          # No limit on connections per child (will recycle by time)

# Connection timeouts
connection_life_time = 0           # Don't expire idle connections (let app manage)
client_idle_limit = 0              # Don't disconnect idle clients

# Process management
reserved_connections = 10          # Reserve connections for superuser/admin

# pid_file_name = '/var/run/pgpool/pgpool.pid'  # Disabled to avoid conflicts

#------------------------------------------------------------------------------
# LOAD BALANCING MODE
#------------------------------------------------------------------------------
load_balance_mode = on
# Use session-level load balancing to keep connection sticky
# This ensures DML queries go to the same backend throughout the session
statement_level_load_balance = off
ignore_leading_white_space = on

# Write/Read split configuration
# With 'always', ALL writes go to primary regardless of transaction
disable_load_balance_on_write = 'always'
dml_adaptive_object_relationship_list = ''
black_function_list = 'nextval,setval,pg_catalog.nextval,pg_catalog.setval,currval,lastval'
white_function_list = ''
black_query_pattern_list = ''
white_query_pattern_list = ''

#------------------------------------------------------------------------------
# STREAMING REPLICATION MODE
#------------------------------------------------------------------------------
sr_check_period = 10
sr_check_user = 'repmgr'
sr_check_password = 'repmgrpass'
sr_check_database = 'postgres'
delay_threshold = 10485760  # 10MB in bytes

#------------------------------------------------------------------------------
# HEALTH CHECK
#------------------------------------------------------------------------------
health_check_period = 30
health_check_timeout = 5
health_check_user = 'repmgr'
health_check_password = 'repmgrpass'
health_check_database = 'postgres'
health_check_max_retries = 3
health_check_retry_delay = 5
connect_timeout = 10000

#------------------------------------------------------------------------------
# FAILOVER AND FAILBACK
#------------------------------------------------------------------------------
failover_on_backend_error = off
failover_command = '/usr/local/bin/failover.sh %d %h %p %D %m %H %M %P %r %R %N %S'
failback_command = ''
failover_require_consensus = off
search_primary_node_timeout = 300

#------------------------------------------------------------------------------
# WATCHDOG (for pgpool-II HA)
# Watchdog disabled - using HAProxy for health checks instead
#------------------------------------------------------------------------------
use_watchdog = off

# This pgpool node
wd_hostname0 = ''                 # Disabled
wd_port0 = 9000
wd_priority0 = 1                  # Will be set via environment variable

# Common watchdog settings (disabled)
wd_authkey = ''
wd_ipc_socket_dir = '/var/run/pgpool'
delegate_ip = ''                  # No VIP in Docker
if_up_cmd = ''
if_down_cmd = ''
arping_cmd = ''

# Watchdog heartbeat (disabled)
wd_heartbeat_port0 = 9694
wd_heartbeat_keepalive0 = 2
wd_heartbeat_deadtime0 = 30

# Other pgpool monitoring (disabled)
wd_monitoring_interfaces_list = ''
wd_lifecheck_method = 'heartbeat'
wd_interval = 10

# Virtual IP interface (disabled in Docker)
wd_escalation_command = ''
wd_de_escalation_command = ''

# Watchdog lifecycle (disabled)
wd_life_point = 3
wd_lifecheck_query = 'SELECT 1'
wd_lifecheck_dbname = 'postgres'
wd_lifecheck_user = 'repmgr'
wd_lifecheck_password = ''

# Other watchdog nodes (disabled)
other_pgpool_hostname0 = ''
other_pgpool_port0 = 5432
other_wd_port0 = 9000

# Heartbeat destination (disabled)
heartbeat_hostname0 = ''
heartbeat_port0 = 9694
heartbeat_device0 = ''

#------------------------------------------------------------------------------
# CONNECTION POOL
# Optimized for 32 GB RAM
#------------------------------------------------------------------------------
connection_cache = on
reset_query_list = 'ABORT; DISCARD ALL'

# Authentication method for backend connections â€” use SCRAM everywhere
backend_auth_method = 'scram-sha-256'

#------------------------------------------------------------------------------
# MEMORY CACHE (Query Result Cache)
# Enable for read-heavy workloads with 32 GB RAM
#------------------------------------------------------------------------------
memory_cache_enabled = on                         # Enable query result caching
memqcache_method = 'shmem'                       # Use shared memory (faster than memcached)
memqcache_memqcache_total_size = 4GB             # Total cache size (4GB of 32GB)
memqcache_max_num_cache = 1000000                # Max cached query results
memqcache_expire = 300                           # Cache TTL: 5 minutes
memqcache_auto_cache_invalidation = on           # Invalidate on table updates
memqcache_maxcache = 4MB                         # Max size per cached result
memqcache_cache_block_size = 1MB                 # Block size for cache storage

# What to cache (read-only SELECT queries)
white_memqcache_table_list = ''                  # Cache all tables (or specify: 'table1,table2')
black_memqcache_table_list = 'pg_*,information_schema.*'  # Don't cache system tables

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------
log_destination = 'stderr'
log_line_prefix = '%t: pid %p: '
log_connections = off
log_disconnections = off
log_hostname = on
log_statement = off
log_per_node_statement = off
log_client_messages = off
log_standby_delay = 'if_over_threshold'
log_min_messages = warning

#------------------------------------------------------------------------------
# PCP (pgpool Control Protocol)
#------------------------------------------------------------------------------
pcp_socket_dir = '/var/run/pgpool'

#------------------------------------------------------------------------------
# MEMORY CACHE
#------------------------------------------------------------------------------
memory_cache_enabled = off

#------------------------------------------------------------------------------
# MISC
#------------------------------------------------------------------------------
relcache_expire = 0
relcache_size = 256

enable_pool_hba = on
pool_passwd = '/run/pgpool/pool_passwd'
authentication_timeout = 60

# Do NOT allow clear text frontend passwords in pool_passwd; require SCRAM/hashed entries
allow_clear_text_frontend_auth = off
